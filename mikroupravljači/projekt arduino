  #include <Keypad.h>
#include <LiquidCrystal_I2C.h>

LiquidCrystal_I2C lcd(0x27,16,2);

const byte REDOVI = 4;
const byte STUPCI = 4;

char hexaKeys[REDOVI][STUPCI] = {
  {'1', '2', '3', 'A'}, 
  {'4', '5', '6', 'B'},
  {'7', '8', '9', 'C'},
  {'*', '0', '#', 'D'}
};

byte redPinovi[REDOVI] = {2, 3, 4, 5};
byte stupacPinovi[STUPCI] = {6, 7, 8, 9};

Keypad customKeypad = Keypad(makeKeymap(hexaKeys), redPinovi, stupacPinovi, REDOVI, STUPCI);

const int trigPin = 11;
const int echoPin = 12;
const int buzzer = 10;
const int ledPin = 13;

String unesenaLozinka = "";
const String ispravnaLozinka = "1234A";
bool alarmAktivan = false;

void setup() {
  pinMode(trigPin, OUTPUT);
  pinMode(echoPin, INPUT);
  pinMode(buzzer, OUTPUT);
  pinMode(ledPin, OUTPUT);
  digitalWrite(ledPin, LOW);
  noTone(buzzer);
  Serial.begin(9600);
  lcd.init();
  lcd.backlight();
}

void loop() {
  char ZNAK = customKeypad.getKey();
  
  if (ZNAK) {
    lcd.clear();
    Serial.print("Uneseno: ");
    Serial.println(ZNAK);
    lcd.print("Uneseno: ");
    lcd.println(ZNAK);
    if (ZNAK == '*') {
      unesenaLozinka = "";
      Serial.println("Unos resetiran");
      lcd.println("Unos resetiran");
    } else {
      unesenaLozinka += ZNAK;
    }
    
    if (unesenaLozinka.length() >= ispravnaLozinka.length()) {
      if (unesenaLozinka == ispravnaLozinka) {
        alarmAktivan = !alarmAktivan;
        Serial.println(alarmAktivan ? "Alarm aktiviran" : "Alarm deaktiviran");
        lcd.println(alarmAktivan ? "Alarm aktiviran" : "Alarm deaktiviran");
        if (alarmAktivan) {
          digitalWrite(ledPin, LOW);
        } else {
          digitalWrite(ledPin, HIGH);
          noTone(buzzer);
        }
      } else {
        Serial.println("Pogrešna lozinka");
        lcd.println("Pogrešna lozinka");
      }
      unesenaLozinka = "";
    }
  }

  long trajanje, udaljenost;
  digitalWrite(trigPin, LOW);
  delayMicroseconds(2);
  digitalWrite(trigPin, HIGH);
  delayMicroseconds(10);
  digitalWrite(trigPin, LOW);
  
  trajanje = pulseIn(echoPin, HIGH);
  udaljenost = trajanje * 0.034 / 2;

  if (alarmAktivan) {
    if (udaljenost < 5) {
      tone(buzzer, 1000);
      digitalWrite(ledPin, LOW);
    } else {
      noTone(buzzer);
    }
  }
}
